# Changelog

Todas as mudancas relevantes deste projeto serao documentadas neste arquivo.

O formato segue [Keep a Changelog](https://keepachangelog.com/pt-BR/1.1.0/),
e este projeto adere ao [Versionamento Semantico](https://semver.org/lang/pt-BR/).

## [Unreleased]

### Added
- Endpoint WebSocket `WS /v1/realtime` com handshake (model, language, session_id) e protocolo de eventos JSON (#M5-T5-02)
- Pydantic models para 8 tipos de evento servidor e 4 tipos de comando cliente WebSocket (#M5-T5-01)
- Protocol handler `dispatch_message()` para dispatch tipado de frames binarios e comandos JSON (#M5-T5-03)
- Heartbeat WebSocket com ping a cada 10s e timeout de inatividade configuravel (#M5-T5-04)
- `EnergyPreFilter` com RMS + spectral flatness para pre-filtragem de silencio antes do Silero VAD (#M5-T5-05)
- `SileroVADClassifier` com lazy-loading do modelo Silero e sensitivity levels (high/normal/low) (#M5-T5-06)
- `VADDetector` coordenando energy pre-filter + Silero com debounce de fala (250ms) e silencio (300ms) (#M5-T5-07)
- `StreamingPreprocessor` adapter frame-by-frame para preprocessing de audio em streaming (#M5-T5-08)
- `StreamingGRPCClient` e `StreamHandle` para streaming gRPC bidirecional runtime-to-worker com crash detection via stream break (#M5-T5-09)
- `STTWorkerServicer.TranscribeStream` implementado como streaming gRPC bidirecional no worker (#M5-T5-10)
- Conversor `transcript_segment_to_proto_event()` para conversao proto de eventos de streaming (#M5-T5-10)
- `FasterWhisperBackend.transcribe_stream()` para transcricao streaming via acumulacao com threshold de 5s (#M5-T5-11)
- `StreamingSession` orquestrando fluxo completo: preprocessing -> VAD -> gRPC worker -> post-processing -> callback (#M5-T5-12)
- `BackpressureController` com sliding window para deteccao de envio mais rapido que real-time e drop de frames por backlog (#M5-T5-13)
- `StreamingSession.commit()` para force commit manual de segmento via `input_audio_buffer.commit` (#M5-T5-14)
- Metricas Prometheus para streaming: `theo_stt_ttfb_seconds`, `theo_stt_final_delay_seconds`, `theo_stt_active_sessions`, `theo_stt_vad_events_total` (#M5-T5-15)
- 218 testes unitarios cobrindo todos os componentes do M5: eventos, protocolo, heartbeat, VAD, preprocessor, gRPC, session, backpressure, metricas (#M5)
- 83 testes de edge cases para M5: frames vazios/oversized, JSON malformado, double close, use-after-close, debounce de VAD em fronteiras, backpressure com zero-byte frames, conversores proto com defaults, precedencia bytes vs text em WebSocket (#M5-T5-16)
- Teste de estabilidade de sessao de 5 minutos (simulada) validando ausencia de memory leak (<10MB) e degradacao de TTFB (<1.2x) (#M5-T5-18)
- Teste de estabilidade com 200 segmentos curtos validando ausencia de vazamento de recursos em ciclos rapidos de open/close de streams gRPC (#M5-T5-18)
- Property `name` na interface `TextStage` ABC para identificacao de stages no post-processing, simetrica com `AudioStage` (#M4-CR-F03)
- Logging por stage no `PostProcessingPipeline.process()` equivalente ao preprocessing pipeline (#M4-CR-F03)
- Re-exports de `AudioPreprocessingPipeline` e `AudioStage` no `theo.preprocessing.__init__` via `__all__` (#M4-CR-F06)
- Script `scripts/demo_m4.sh` para demo end-to-end da Fase 1: preprocessing + post-processing + API + CLI (#M4-DEMO)

### Changed
- Endpoint WebSocket `/v1/realtime` agora integra `StreamingSession` completo: audio frames passam por backpressure -> preprocessing -> VAD -> gRPC worker -> post-processing (#M5-CR2-01)
- `VADDetector` agora faz debounce por total de samples acumulados em vez de contagem de frames, corrigindo calculo para frames de tamanho variavel (#M5-CR2-03)
- `BackpressureController.clock` tipado como `Callable[[], float]` em vez de `object` para type safety (#M5-CR2-02)
- `_create_streaming_session()` com tipo correto `Callable[[ServerEvent], Awaitable[None]]` para `on_event` (#M5-CR2-01)

### Fixed
- Endpoint WebSocket `/v1/realtime` descartava todos os audio frames recebidos sem processamento — agora integra pipeline completo via `StreamingSession` (#M5-CR2-01)
- Race condition em `StreamingSession._handle_speech_end()` onde `vad.speech_end` podia ser emitido antes de `transcript.final` — agora aguarda receiver task completar (#M5-CR2-02)
- Cancel RPC no servicer tinha mensagem de erro desatualizada referenciando M5 (#M5-CR2-03)
- `SileroVADClassifier._ensure_model_loaded()` nao era thread-safe — adicionado double-check locking com `threading.Lock` (#M5-CR2-05)
- `_handle_speech_start` agora limpa stream/receiver task anteriores antes de abrir novo stream, evitando leak de recursos em duplo SPEECH_START (#M5-CR-01)
- `_proto_event_to_transcript_segment` preserva `start_ms=0` e `end_ms=0` como valores validos em vez de converter para `None` incorretamente (#M5-CR-05)
- `_send_event` aceita qualquer `ServerEvent` em vez de apenas 3 tipos especificos (#M5-CR-02)
- `SessionConfigureCommand` rejeita timeouts negativos e zero com validacao `Field(gt=0)` (#M5-CR-03)
- `BackpressureController` usa duracao do primeiro frame (constante) em vez do frame atual para calculo de taxa efetiva (#M5-CR-08)
- `suppress(Exception)` no fechamento de WebSocket por inatividade restringido para `suppress(WebSocketDisconnect, RuntimeError, OSError)` (#M5-CR-14)
- Logs de `_send_event` agora incluem `session_id` para correlacao (#M5-CR-13)

### Added
- `SileroVADClassifier.preload()` metodo async que carrega o modelo em thread separada via `run_in_executor`, evitando bloqueio do event loop (#M5-CR-10)

### Fixed
- `theo serve` agora instancia pipelines de preprocessing e postprocessing com config toggles antes de criar a app — sem esse fix os pipelines ficavam `None` em producao (#M4-CR-F01)

### Added
- Interface abstrata `AudioStage` ABC para stages plugaveis do Audio Preprocessing Pipeline (#M4-E1-T1)
- Funcoes `decode_audio()` e `encode_pcm16()` para conversao entre bytes de audio e arrays numpy float32 (#M4-E1-T1)
- `AudioPreprocessingPipeline` que orquestra stages em sequencia: decode -> stages -> encode PCM16 WAV (#M4-E1-T1)
- 26 testes unitarios cobrindo AudioStage ABC, decode/encode de audio e pipeline de preprocessamento (#M4-E1-T1)
- `ResampleStage` para conversao de qualquer sample rate para 16kHz via `scipy.signal.resample_poly` (#M4-E1-T2)
- `DCRemoveStage` com filtro Butterworth HPF 2a ordem a 20Hz para remocao de DC offset (#M4-E1-T3)
- `GainNormalizeStage` com peak normalization para -3dBFS e protecao contra clipping (#M4-E1-T4)
- Integracao do Audio Preprocessing Pipeline no fluxo batch: audio preprocessado automaticamente antes do worker (#M4-E1-T5)
- Interface abstrata `TextStage` ABC para stages plugaveis do Post-Processing Pipeline (#M4-E2-T1)
- `PostProcessingPipeline` que orquestra stages de texto em sequencia com suporte a `BatchResult` imutavel (#M4-E2-T1)
- `ITNStage` para Inverse Text Normalization via `nemo_text_processing` com fallback graceful quando pacote nao instalado (#M4-E2-T2)
- Integracao do Post-Processing Pipeline no fluxo batch: texto formatado automaticamente apos transcricao (#M4-E2-T3)
- Parametro `itn` nos endpoints REST `/v1/audio/transcriptions` e `/v1/audio/translations` para controle de ITN por request (#M4-E3-T1)
- Flag `--no-itn` nos comandos CLI `theo transcribe` e `theo translate` para desabilitar ITN (#M4-E3-T1)
- Testes end-to-end validando pipeline completo: audio em qualquer sample rate -> preprocessing -> transcricao -> post-processing -> resposta formatada (#M4-E3-T2)
- FastAPI application factory `create_app()` com injecao de dependencias via Registry e Scheduler (#M3-E1)
- Endpoint `GET /health` retornando status e versao do runtime (#M3-E1)
- Endpoint `POST /v1/audio/transcriptions` compativel com contrato OpenAI Audio API (#M3-E3)
- Endpoint `POST /v1/audio/translations` com task=translate para traducao para ingles (#M3-E3)
- Pydantic models para request/response: `TranscriptionRequest`, `TranslationRequest`, `TranscriptionResponse`, `VerboseTranscriptionResponse` (#M3-E2)
- `ModelRegistry` para scan de modelos em disco, resolucao por nome e listagem de manifestos (#M3-E4)
- `Scheduler` basico que roteia requests para workers disponiveis e converte resultados (#M3-E5)
- Conversor `BatchResult` -> proto `TranscribeFileRequest` no scheduler (#M3-E5)
- Formatos de resposta: `json`, `verbose_json`, `text`, `srt`, `vtt` com formatters dedicados (#M3-E6)
- Error handlers HTTP: 400 (audio invalido), 400 (request invalido), 404 (modelo nao encontrado), 413 (arquivo grande), 503 (worker indisponivel), 500 (erro interno) com formato OpenAI-compatible (#M3-E7)
- `InvalidRequestError` na hierarquia de exceptions para parametros de request invalidos (#M3-CR1)
- CLI: `theo serve` — inicia API Server com workers gRPC para modelos STT instalados (#M3-E8)
- CLI: `theo transcribe <file>` — transcreve arquivo via HTTP com opcoes de formato, idioma e modelo (#M3-E8)
- CLI: `theo translate <file>` — traduz arquivo via HTTP com opcoes de formato e modelo (#M3-E8)
- CLI: `theo list` — lista modelos instalados com tabela formatada (nome, tipo, engine, arquitetura, memoria) (#M3-E8)
- CLI: `theo inspect <model>` — exibe detalhes completos de um modelo instalado (#M3-E8)
- Entry point `theo` via `pyproject.toml` scripts (#M3-E8)
- 18 testes end-to-end validando pipeline completo HTTP -> Scheduler(mock) -> Response para todos os formatos e cenarios de erro (#M3-E9)
- 4 testes de integracao validando compatibilidade com SDK `openai` Python como cliente real (#M3-E10)
- 25 testes unitarios para CLI (serve, transcribe, translate, list, inspect) (#M3-E8)
- Plano estrategico detalhado `docs/STRATEGIC_M3.md` com 5 entregas e 13 tasks (#M3-E0)
- Estrutura de projeto com `pyproject.toml`, src layout e extras opcionais (#M1-I1)
- Tooling: ruff (lint+format), mypy (strict), pytest com pytest-asyncio (#M1-I2)
- CI basico via GitHub Actions com matrix Python 3.11/3.12 (#M1-I3)
- Tipos fundamentais: `STTArchitecture`, `ModelType`, `SessionState`, `VADSensitivity`, `ResponseFormat`, `TranscriptSegment`, `BatchResult`, `EngineCapabilities` (#M1-I4)
- Hierarquia de exceptions tipadas por dominio: `TheoError`, `ConfigError`, `ModelError`, `WorkerError`, `AudioError`, `SessionError` (#M1-I5)
- Parsing e validacao de manifestos `theo.yaml` via `ModelManifest` com Pydantic v2 (#M1-I6)
- Interface abstrata `STTBackend` ABC para engines STT plugaveis (#M1-I7)
- Protobuf gRPC `stt_worker.proto` com servico `STTWorker` (#M1-I7)
- Configuracoes de preprocessing e postprocessing com defaults (#M1-I6)
- Fixtures de teste: audio WAV (16kHz, 8kHz, 44.1kHz) e manifestos YAML (#M1-AUX)
- 56 testes unitarios cobrindo tipos, exceptions, manifesto, configs e contrato STTBackend (#M1-AUX)
- Pipeline de CD: workflow de release via tag `v*` com build de wheel e GitHub Release (#CD-01)
- Build validation no CI: verificacao de conteudo do wheel e consistencia de versao (#CD-02)
- Documentacao de CD pipeline com ADR-011 e estrategia de versionamento (#CD-03)
- Script `scripts/generate_proto.sh` para compilacao de protobuf com fix de import paths (#M2-I1)
- Stubs protobuf gerados e commitados: `stt_worker_pb2.py`, `stt_worker_pb2_grpc.py` (#M2-I1)
- Re-exports em `theo.proto.__init__` para imports limpos de mensagens e servicos gRPC (#M2-I1)
- Structured logging via structlog com formatos JSON e console: `configure_logging()`, `get_logger()` (#M2-AUX)
- Conversores puros proto<->Theo em `theo.workers.stt.converters` (#M2-I2)
- gRPC servicer `STTWorkerServicer` com TranscribeFile, Health e stubs UNIMPLEMENTED (#M2-I2)
- Entry point de worker STT como subprocess: `python -m theo.workers.stt` com argparse (#M2-I2)
- `FasterWhisperBackend` implementando `STTBackend` com transcricao batch, hot words via initial_prompt e conversao PCM->numpy (#M2-I3)
- `WorkerManager` para lifecycle de workers como subprocessos: spawn, health probe com backoff, crash detection, auto-restart com rate limiting e shutdown graceful (#M2-I4)
- 71 novos testes unitarios: converters (12), servicer (11), faster-whisper backend (21), worker manager (16), logging (6), integracao (5) (#M2-I5)
- Verificacao de freshness dos stubs proto no CI (#M2-I1)
- `WorkerCrashError` e `WorkerTimeoutError` na hierarquia de exceptions para erros de worker gRPC (#M3-CR6)
- Modulo `server/constants.py` com constantes centralizadas de limites e content-types (#M3-CR9)
- Modulo `server/routes/_common.py` com logica compartilhada entre rotas de audio (#M3-CR8)
- Testes para gRPC error translation: DEADLINE_EXCEEDED -> WorkerTimeoutError, UNAVAILABLE -> WorkerCrashError (#M3-CR6)
- Testes para HTTP 504 (WorkerTimeout) e 502 (WorkerCrash) nos error handlers (#M3-CR14)
- Testes para validacao de content-type em uploads de audio (#M3-CR10)
- Testes para timestamps negativos e segmentos vazios nos formatters SRT/VTT (#M3-CR22)
- Testes para campo `task` no scheduler e health endpoint com version/models_loaded (#M3-CR7)

### Changed
- Dependencias core: adicionados `click>=8.0` e `httpx>=0.27` para CLI e HTTP client (#M3-E8)
- Dependencias dev: adicionado `openai>=1.0` para testes de compatibilidade com SDK (#M3-E10)
- `pyproject.toml`: filtros de warnings para websockets DeprecationWarning e ResourceWarning (#M3-E10)
- Campos `compression_ratio` e `probability` adicionados aos tipos `SegmentDetail` e `WordTimestamp` (#M2-I0)
- Proto `Segment` e `Word` estendidos com campos `compression_ratio` e `probability` (#M2-I0)
- Dependencias core: adicionados `structlog>=24.0` e `numpy>=1.26` (#M2-I0)
- Dependencias dev: adicionado `types-grpcio>=1.0` para type stubs gRPC (#M2-I0)
- CI instala extras `dev,grpc` para suportar compilacao e testes de proto (#M2-I1)
- Ruff config: excluidos arquivos gerados `stt_worker_pb2*.py` do linting (#M2-I0)
- Mypy config: override para `faster_whisper.*` (import opcional) (#M2-I0)
- README: tabela de compatibilidade com endpoints OpenAI API (#README-01)
- README: secao Quick Start com exemplo minimo de uso (#README-02)
- README: diagrama de arquitetura convertido para Mermaid (#README-03)
- README: licenca atualizada de "A definir" para MIT (consistente com pyproject.toml) (#README-04)

### Fixed
- `response_format` invalido agora retorna 400 com mensagem descritiva em vez de 500 generico (#M3-CR1)
- Endpoints de transcricao e traducao agora rejeitam upload antes de ler arquivo quando `Content-Length` excede limite de 25MB (#M3-CR2)
- Formatters SRT e VTT agora fazem carry correto de milissegundos em timestamps de fronteira (ex: 59.9999s -> 00:01:00,000) (#M3-CR3)
- `STTWorkerServicer.TranscribeFile` agora tem return explicito apos `context.abort` evitando `UnboundLocalError` se abort nao levantar excecao (#M2-CR1)
- Logica duplicada de construcao de comando CLI no `WorkerManager` extraida para `_build_worker_cmd` e `_spawn_worker_process` (#M2-CR2)
- `_check_worker_health` moveu import de `STTWorkerStub` para fora do bloco try, evitando potencial leak de channel gRPC (#M2-CR3)
- Signal handler no worker STT agora protege contra duplo shutdown com flag `shutting_down` e funcao nomeada em vez de lambda (#M2-CR4)
- Background tasks do `WorkerManager` agora sao awaited apos cancel em `stop_worker` e removidas do dict via `_cancel_background_tasks` (#M2-CR5)
- Subprocess do worker usa `DEVNULL` em vez de `PIPE` para stdout/stderr, eliminando risco de deadlock quando worker gera output (#M2-CR6)
- `_attempt_restart` nao cancela mais as proprias background tasks (self-cancellation bug), substitui diretamente no dict (#M2-CR7)
- gRPC channel options no Scheduler: max_receive_message_length=30MB, keepalive_time=30s, keepalive_timeout=10s (#M3-CR4)
- gRPC timeout proporcional ao tamanho do audio no Scheduler: base 30s + 1s/MB (#M3-CR5)
- gRPC DEADLINE_EXCEEDED traduzido para `WorkerTimeoutError` e UNAVAILABLE para `WorkerCrashError` no Scheduler (#M3-CR6)
- Campo `task` agora propagado no proto `TranscribeFileRequest` para diferenciar transcribe/translate (#M3-CR7)
- Rotas de transcricao e traducao deduplicadas via modulo `_common.py` com `handle_audio_request()` (#M3-CR8)
- Constantes `MAX_FILE_SIZE_BYTES` e `ALLOWED_AUDIO_CONTENT_TYPES` centralizadas em `server/constants.py` (#M3-CR9)
- Content-type de upload validado contra frozenset de tipos permitidos antes de ler arquivo (#M3-CR10)
- Leitura de arquivo com limite `MAX_FILE_SIZE_BYTES + 1` para prevenir OOM em uploads sem Content-Length (#M3-CR11)
- Dependencias (`get_registry`, `get_scheduler`) agora fazem fail-fast com `InvalidRequestError` se None (#M3-CR12)
- Error handlers incluem `exc_info=True` e `request_id` para correlacao de logs (#M3-CR13)
- `WorkerTimeoutError` retorna HTTP 504 (Gateway Timeout) em vez de 503 generico (#M3-CR14)
- `WorkerCrashError` retorna HTTP 502 (Bad Gateway) com header `Retry-After: 5` (#M3-CR15)
- `theo serve` agora faz bind em `127.0.0.1` por default em vez de `0.0.0.0` (#M3-CR16)
- Shutdown graceful do CLI serve usa `loop.add_signal_handler` em vez de `signal.signal` para compatibilidade com asyncio (#M3-CR17)
- Worker stderr capturado via `subprocess.PIPE` e logado (ultimos 2000 chars) em caso de crash (#M3-CR18)
- Health endpoint retorna campo `version` (via `theo.__version__`) e `models_loaded` quando registry disponivel (#M3-CR19)
- Versao do CLI centralizada via `theo.__version__` eliminando string duplicada (#M3-CR20)
- `DEFAULT_MODELS_DIR` deduplicado entre `cli/serve.py` e `cli/models.py` (#M3-CR21)
- Formatters SRT e VTT agora ignoram segmentos com texto vazio/whitespace-only (#M3-CR22)
- Formatters SRT e VTT clampeiam timestamps negativos para zero (#M3-CR23)
- Conversor proto usa `probability` 0.0 como default em vez de campo ausente para `no_speech_prob` (#M3-CR24)
